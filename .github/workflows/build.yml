name: Build OpenWrt x86_64 10G

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: write

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Install system dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib \
        git gettext libncurses-dev libssl-dev python3 python3-pip python3-setuptools \
        rsync unzip zlib1g-dev file wget subversion swig time xsltproc

    - name: Clone OpenWrt source
      run: |
        git clone https://github.com/openwrt/openwrt.git openwrt
        cd openwrt
        # copy feeds and config from repo root into openwrt dir
        cp ../feeds.conf.default ./feeds.conf.default || true
        cp ../config/.config ./.config || true
        # ensure custom packages folder exists
        mkdir -p package/community

    - name: Clone common 3rd-party packages into package/community (to avoid feed mismatch)
      run: |
        cd openwrt
        # shallow clone to save time; if a repo changes URL later you can update these
        git clone --depth 1 https://github.com/xiaorouji/openwrt-passwall-packages.git package/community/passwall-packages || true
        git clone --depth 1 https://github.com/xiaorouji/openwrt-passwall.git package/community/passwall || true
        git clone --depth 1 https://github.com/fw876/helloworld.git package/community/helloworld || true
        git clone --depth 1 https://github.com/rufengsuixing/luci-app-adguardhome.git package/community/adguard || true
        git clone --depth 1 https://github.com/pymumu/smartdns.git package/community/smartdns || true

    - name: Update & install feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Apply defconfig
      run: |
        cd openwrt
        make defconfig -j$(nproc)

    - name: Build (may take long)
      run: |
        cd openwrt
        # try parallel build; if fails try single-thread verbose
        make -j$(nproc) V=s || (make -j1 V=s)

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-x86-10g
        path: openwrt/bin/targets/x86/64/
